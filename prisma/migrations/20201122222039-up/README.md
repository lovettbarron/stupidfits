# Migration `20201122222039-up`

This migration has been generated by Andrew Lovett-Barron at 11/22/2020, 11:20:39 PM.
You can check out the [state of the schema](./schema.prisma) after the migration.

## Database Steps

```sql
CREATE TYPE "BattleType" AS ENUM ('POPULAR', 'PANEL')

ALTER TABLE "public"."BattleMatchup" DROP CONSTRAINT "BattleMatchup_battleRoundId_fkey"

ALTER TABLE "public"."BattleVote" DROP CONSTRAINT "BattleVote_battleMatchupId_fkey"

ALTER TABLE "public"."_BattleMatchupToFit" DROP CONSTRAINT "_BattleMatchupToFit_A_fkey"

ALTER TABLE "public"."Battle" ADD COLUMN "type" "BattleType"  NOT NULL DEFAULT E'POPULAR'

ALTER TABLE "public"."BattleMatchup" DROP CONSTRAINT "BattleMatchup_pkey",
DROP COLUMN "battleRoundId",
ADD COLUMN "round" integer   NOT NULL ,
ADD COLUMN "battleMatchupId" text   ,
ALTER COLUMN "id" SET DATA TYPE text ,
ALTER COLUMN "id" DROP DEFAULT,
ALTER COLUMN "id" DROP DEFAULT,
ADD PRIMARY KEY ("id");
DROP SEQUENCE "BattleMatchup_id_seq"

ALTER TABLE "public"."BattleVote" ADD COLUMN "comment" text   NOT NULL ,
ALTER COLUMN "battleMatchupId" SET DATA TYPE text 

ALTER TABLE "public"."_BattleMatchupToFit" ALTER COLUMN "A" SET DATA TYPE text 

CREATE TABLE "public"."_battleJudges" (
"A" integer   NOT NULL ,
"B" integer   NOT NULL 
)

CREATE UNIQUE INDEX "_battleJudges_AB_unique" ON "public"."_battleJudges"("A", "B")

CREATE INDEX "_battleJudges_B_index" ON "public"."_battleJudges"("B")

ALTER TABLE "public"."_battleJudges" ADD FOREIGN KEY ("A")REFERENCES "public"."Battle"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."_battleJudges" ADD FOREIGN KEY ("B")REFERENCES "public"."users"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."BattleMatchup" ADD FOREIGN KEY ("battleMatchupId")REFERENCES "public"."BattleMatchup"("id") ON DELETE SET NULL ON UPDATE CASCADE

ALTER TABLE "public"."BattleVote" ADD FOREIGN KEY ("battleMatchupId")REFERENCES "public"."BattleMatchup"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."_BattleMatchupToFit" ADD FOREIGN KEY ("A")REFERENCES "public"."BattleMatchup"("id") ON DELETE CASCADE ON UPDATE CASCADE

DROP TABLE "public"."BattleRound"
```

## Changes

```diff
diff --git schema.prisma schema.prisma
migration 20201120130104-up..20201122222039-up
--- datamodel.dml
+++ datamodel.dml
@@ -4,9 +4,9 @@
 }
 datasource db {
   provider = "postgresql"
-  url = "***"
+  url = "***"
 }
 model Account {
   id                 Int       @id @default(autoincrement())
@@ -77,8 +77,9 @@
   Collection   Collection[]
   Notification Notification[]
   Battle       Battle[]
   BattleVote   BattleVote[]
+  BattleJudge  Battle[]       @relation(name: "battleJudges")
   @@map(name: "users")
 }
 model VerificationRequest {
@@ -270,15 +271,17 @@
   userId Int
 }
 model Battle {
-  id        Int      @id @default(autoincrement())
-  startDate DateTime @default(now())
-  endDate   DateTime @default(now())
+  id        Int        @id @default(autoincrement())
+  startDate DateTime   @default(now())
+  endDate   DateTime   @default(now())
   rules     String
+  type      BattleType @default(value: POPULAR)
   user          User            @relation(fields: [userId], references: [id])
+  judges        User[]          @relation(name: "battleJudges")
   collection    Collection      @relation(fields: [collectionId], references: [id])
   tags          Style[]
   Comment       Comment[]
   createdAt     DateTime        @default(now()) @map(name: "created_at")
@@ -287,36 +290,32 @@
   userId        Int
   collectionId  Int
 }
-model BattleRound {
-  id        Int             @id @default(autoincrement())
-  matchups  BattleMatchup[]
-  createdAt DateTime        @default(now()) @map(name: "created_at")
-  updatedAt DateTime        @default(now()) @map(name: "updated_at")
+model BattleMatchup {
+  id       String          @id @default(uuid())
+  battle   Battle          @relation(fields: [battleId], references: [id])
+  round    Int
+  Fits     Fit[]
+  parents  BattleMatchup[] @relation("BattleMatchupToBattleMatchup")
+  votes    BattleVote[]
+  battleId Int
+  BattleMatchup   BattleMatchup? @relation("BattleMatchupToBattleMatchup", fields: [battleMatchupId], references: [id])
+  battleMatchupId String?
 }
-model BattleMatchup {
-  id            Int          @id @default(autoincrement())
-  battle        Battle       @relation(fields: [battleId], references: [id])
-  round         BattleRound  @relation(fields: [battleRoundId], references: [id])
-  Fits          Fit[]
-  votes         BattleVote[]
-  battleId      Int
-  battleRoundId Int
-}
-
 model BattleVote {
   id        Int           @id @default(autoincrement())
   user      User          @relation(fields: [userId], references: [id])
   matchup   BattleMatchup @relation(fields: [battleMatchupId], references: [id])
   fit       Fit           @relation(fields: [fitId], references: [id])
   createdAt DateTime      @default(now()) @map(name: "created_at")
   updatedAt DateTime      @default(now()) @map(name: "updated_at")
+  comment   String
   userId          Int
-  battleMatchupId Int
+  battleMatchupId String
   fitId           Int
 }
 enum ReviewFocus {
@@ -405,4 +404,9 @@
   QUEER
   INTER
   OTHER
 }
+
+enum BattleType {
+  POPULAR
+  PANEL
+}
```


